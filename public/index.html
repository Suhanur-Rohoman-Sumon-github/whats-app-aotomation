<!doctype html>
<html lang="en" class="dark">
  <head>
    <meta charset="UTF-8" />
    <title>WhatsApp Bot | Order Automation</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link
      href="https://cdn.jsdelivr.net/npm/lucide-static@0.321.0/font/lucide.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        background: #09090b;
        color: #fafafa;
        font-family: "Inter", sans-serif;
      }
      .nav-item.active {
        background: #27272a;
        color: #fff;
      }
      .card {
        background: #09090b;
        border: 1px solid #27272a;
        border-radius: 8px;
      }
      .sidebar {
        width: 260px;
        border-right: 1px solid #27272a;
      }
      /* Custom scrollbar for dark mode */
      ::-webkit-scrollbar {
        width: 6px;
      }
      ::-webkit-scrollbar-thumb {
        background: #27272a;
        border-radius: 10px;
      }
    </style>
  </head>
  <body class="flex h-screen overflow-hidden">
    <!-- Sidebar -->
    <aside class="sidebar flex flex-col p-6">
      <div class="flex items-center gap-3 mb-10 px-2">
        <div class="bg-green-600 p-2 rounded-lg text-white">
          <i class="lucide-message-square w-5 h-5"></i>
        </div>
        <div class="leading-tight">
          <h1 class="font-bold text-sm">WhatsApp Bot</h1>
          <p class="text-[10px] text-zinc-500 uppercase tracking-wider">
            Order Automation
          </p>
        </div>
      </div>

      <nav class="flex flex-col gap-1">
        <button
          onclick="showPage('dashboard')"
          id="btn-dashboard"
          class="nav-item active flex items-center gap-3 px-3 py-2 rounded-md text-sm text-zinc-400 hover:text-white transition-all"
        >
          <i class="lucide-layout-dashboard w-4 h-4"></i> Dashboard
        </button>
        <button
          onclick="showPage('orders')"
          id="btn-orders"
          class="nav-item flex items-center gap-3 px-3 py-2 rounded-md text-sm text-zinc-400 hover:text-white transition-all"
        >
          <i class="lucide-package w-4 h-4"></i> Orders
        </button>
        <button
          onclick="showPage('admins')"
          id="btn-admins"
          class="nav-item flex items-center gap-3 px-3 py-2 rounded-md text-sm text-zinc-400 hover:text-white transition-all"
        >
          <i class="lucide-shield w-4 h-4"></i> Admins
        </button>
        <button
          onclick="showPage('clients')"
          id="btn-clients"
          class="nav-item flex items-center gap-3 px-3 py-2 rounded-md text-sm text-zinc-400 hover:text-white transition-all"
        >
          <i class="lucide-user-plus w-4 h-4"></i> Clients
        </button>
        <button
          onclick="showPage('whatsapp')"
          id="btn-whatsapp"
          class="nav-item flex items-center gap-3 px-3 py-2 rounded-md text-sm text-zinc-400 hover:text-white transition-all"
        >
          <i class="lucide-smartphone w-4 h-4"></i> WhatsApp
        </button>
      </nav>

      <div class="mt-auto px-2">
        <p class="text-[10px] text-zinc-600 font-medium">Phase 1 - MVP</p>
      </div>
    </aside>

    <!-- Main Area -->
    <main class="flex-1 overflow-y-auto p-10">
      <!-- DASHBOARD PAGE -->
      <section id="page-dashboard">
        <div class="mb-8">
          <h2 class="text-3xl font-bold tracking-tight">Dashboard</h2>
          <p class="text-zinc-500 text-sm">
            Monitor order flow and system status in real-time
          </p>
        </div>

        <div class="grid grid-cols-4 gap-4 mb-8" id="stats-container">
          <!-- Stats injected by JS -->
        </div>

        <div class="card overflow-hidden">
          <div
            class="p-4 border-b border-zinc-800 font-semibold flex items-center justify-between"
          >
            <span>Recent Orders</span>
            <i class="lucide-trending-up w-4 h-4 text-zinc-500"></i>
          </div>
          <table class="w-full text-sm text-left">
            <thead
              class="bg-zinc-900/50 text-zinc-500 uppercase text-[10px] font-bold"
            >
              <tr>
                <th class="px-6 py-3">Order ID</th>
                <th class="px-6 py-3">Customer</th>
                <th class="px-6 py-3">Assigned Admin</th>
                <th class="px-6 py-3">Status</th>
                <th class="px-6 py-3">Time</th>
              </tr>
            </thead>
            <tbody id="dashboard-orders-tbody"></tbody>
          </table>
        </div>
      </section>

      <!-- ADMINS PAGE -->
      <section id="page-admins" class="hidden">
        <div class="flex justify-between items-end mb-8">
          <div>
            <h2 class="text-3xl font-bold">Admins</h2>
            <p class="text-zinc-500 text-sm">
              Manage admins for order distribution
            </p>
          </div>
          <button
            onclick="openModal('admin')"
            class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md text-sm font-medium flex items-center gap-2"
          >
            <i class="lucide-plus w-4 h-4"></i> Add Admin
          </button>
        </div>
        <div id="admins-list" class="grid grid-cols-3 gap-4">
          <!-- Admin cards injected here -->
        </div>
      </section>

      <!-- CLIENTS PAGE -->
      <section id="page-clients" class="hidden">
        <div class="flex justify-between items-end mb-8">
          <div>
            <h2 class="text-3xl font-bold">Clients</h2>
            <p class="text-zinc-500 text-sm">
              Manage authorized clients for the bot
            </p>
          </div>
          <button
            onclick="openModal('client')"
            class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md text-sm font-medium flex items-center gap-2"
          >
            <i class="lucide-plus w-4 h-4"></i> Add Client
          </button>
        </div>
        <div id="clients-list" class="grid grid-cols-3 gap-4">
          <!-- Client cards injected here -->
        </div>
      </section>

      <!-- WHATSAPP PAGE -->
      <section id="page-whatsapp" class="hidden">
        <div class="flex justify-between items-center mb-8">
          <h2 class="text-3xl font-bold">WhatsApp Connection</h2>
          <button
            onclick="logoutWA()"
            class="text-red-500 border border-red-500/20 px-4 py-2 rounded-md text-xs hover:bg-red-500/10"
          >
            Disconnect
          </button>
        </div>
        <div class="grid grid-cols-2 gap-8">
          <div class="card p-6">
            <h3 class="font-bold text-sm mb-4">Connection Status</h3>
            <div class="bg-zinc-900/50 p-4 rounded-lg flex flex-col gap-3">
              <div class="flex justify-between items-center">
                <span class="text-zinc-500 text-sm">Status</span>
                <span
                  id="conn-status-text"
                  class="text-red-500 text-sm font-bold flex items-center gap-2"
                  >● Disconnected</span
                >
              </div>
              <div class="flex justify-between items-center">
                <span class="text-zinc-500 text-sm">Phone Number</span>
                <span
                  id="conn-phone-text"
                  class="text-zinc-300 text-sm font-mono"
                  >None</span
                >
              </div>
            </div>
          </div>
          <div class="card p-6 flex flex-col items-center">
            <h3 class="font-bold text-sm mb-6 w-full text-left">
              QR Code Login
            </h3>
            <div
              id="qr-container"
              class="bg-white p-4 rounded-lg flex items-center justify-center min-h-[220px] min-w-[220px]"
            >
              <p class="text-black text-xs">Waiting for server...</p>
            </div>
          </div>
        </div>
      </section>
    </main>

    <!-- Modal for adding Admin/Client -->
    <div
      id="data-modal"
      class="fixed inset-0 bg-black/80 hidden flex items-center justify-center z-50"
    >
      <div class="card w-[400px] p-6 shadow-2xl">
        <h3 id="modal-title" class="text-xl font-bold mb-4">Add New</h3>
        <div class="space-y-4">
          <div>
            <label class="text-xs text-zinc-500 block mb-1">Name</label>
            <input
              type="text"
              id="m-name"
              class="w-full bg-zinc-900 border border-zinc-800 rounded p-2 text-sm outline-none focus:border-green-600"
            />
          </div>
          <div>
            <label class="text-xs text-zinc-500 block mb-1"
              >Phone Number (with country code)</label
            >
            <input
              type="text"
              id="m-phone"
              placeholder="880123456789"
              class="w-full bg-zinc-900 border border-zinc-800 rounded p-2 text-sm outline-none focus:border-green-600"
            />
          </div>
          <div class="flex gap-2 pt-2">
            <button
              onclick="closeModal()"
              class="flex-1 bg-zinc-800 py-2 rounded text-sm hover:bg-zinc-700"
            >
              Cancel
            </button>
            <button
              onclick="saveData()"
              class="flex-1 bg-green-600 py-2 rounded text-sm font-bold"
            >
              Save Record
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      const socket = io();
      let currentModalType = "";

      // --- PAGE NAVIGATION ---
      function showPage(id) {
        document
          .querySelectorAll("main > section")
          .forEach((s) => s.classList.add("hidden"));
        document.getElementById("page-" + id).classList.remove("hidden");

        document
          .querySelectorAll(".nav-item")
          .forEach((n) => n.classList.remove("active"));
        document.getElementById("btn-" + id).classList.add("active");

        loadData(id);
      }

      // --- DATA LOADING ---
      async function loadData(page) {
        if (page === "dashboard") {
          const stats = await fetch("/api/stats").then((r) => r.json());
          const orders = await fetch("/api/orders").then((r) => r.json());

          document.getElementById("stats-container").innerHTML = `
                    <div class="card p-5">
                        <p class="text-[10px] uppercase text-zinc-500 font-bold mb-1">Total Orders</p>
                        <h4 class="text-2xl font-bold">${stats.total}</h4>
                    </div>
                    <div class="card p-5 border-l-2 border-l-green-600">
                        <p class="text-[10px] uppercase text-zinc-500 font-bold mb-1">Pending</p>
                        <h4 class="text-2xl font-bold">${stats.pending}</h4>
                    </div>
                `;

          document.getElementById("dashboard-orders-tbody").innerHTML = orders
            .slice(0, 10)
            .map(
              (o) => `
                    <tr class="border-b border-zinc-800 hover:bg-zinc-900/30">
                        <td class="px-6 py-4 font-mono text-zinc-400 text-xs">${o.order_id}</td>
                        <td class="px-6 py-4">${o.customer}</td>
                        <td class="px-6 py-4 text-zinc-500">${o.admin_name}</td>
                        <td class="px-6 py-4"><span class="px-2 py-0.5 bg-purple-900/20 text-purple-400 rounded text-[10px] font-bold uppercase border border-purple-900/50">${o.status}</span></td>
                        <td class="px-6 py-4 text-zinc-500 text-xs">${new Date(o.time).toLocaleTimeString()}</td>
                    </tr>
                `,
            )
            .join("");
        }

        if (page === "admins") {
          const admins = await fetch("/api/admins").then((r) => r.json());
          document.getElementById("admins-list").innerHTML = admins
            .map(
              (a) => `
                    <div class="card p-4 flex justify-between items-center group transition-all hover:border-zinc-700">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 bg-zinc-800 rounded-full flex items-center justify-center font-bold text-sm text-zinc-400 uppercase">${a.name[0]}</div>
                            <div>
                                <h4 class="text-sm font-bold text-white leading-tight">${a.name}</h4>
                                <p class="text-[11px] text-zinc-500 tracking-tight">+${a.phone}</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-4">
                            <span class="text-[10px] font-bold text-zinc-600 uppercase tracking-widest">ACTIVE</span>
                            <button onclick="deleteEntry('admins', ${a.id})" class="p-2 bg-zinc-900/50 hover:bg-red-500/10 text-zinc-600 hover:text-red-500 rounded-md transition-all">
                                <i class="lucide-trash-2 w-4 h-4"></i>
                            </button>
                        </div>
                    </div>
                `,
            )
            .join("");
        }

        if (page === "clients") {
          const clients = await fetch("/api/clients").then((r) => r.json());
          document.getElementById("clients-list").innerHTML = clients
            .map(
              (c) => `
                    <div class="card p-4 flex justify-between items-center group transition-all hover:border-zinc-700">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 bg-zinc-800 rounded-full flex items-center justify-center font-bold text-sm text-green-500 uppercase">${c.name[0]}</div>
                            <div>
                                <h4 class="text-sm font-bold text-white leading-tight">${c.name}</h4>
                                <p class="text-[11px] text-zinc-500 tracking-tight">+${c.phone}</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-4">
                            <span class="text-[10px] font-bold text-green-900/40 uppercase tracking-widest">ACTIVE</span>
                            <button onclick="deleteEntry('clients', ${c.id})" class="p-2 bg-zinc-900/50 hover:bg-red-500/10 text-zinc-600 hover:text-red-500 rounded-md transition-all">
                                <i class="lucide-trash-2 w-4 h-4"></i>
                            </button>
                        </div>
                    </div>
                `,
            )
            .join("");
        }
      }

      // --- MODAL LOGIC ---
      function openModal(type) {
        currentModalType = type;
        document.getElementById("modal-title").innerText =
          type === "admin" ? "Add New Admin" : "Add New Client";
        document.getElementById("data-modal").classList.remove("hidden");
      }

      function closeModal() {
        document.getElementById("data-modal").classList.add("hidden");
        document.getElementById("m-name").value = "";
        document.getElementById("m-phone").value = "";
      }

      async function saveData() {
        const name = document.getElementById("m-name").value;
        const phone = document.getElementById("m-phone").value;
        if (!name || !phone) return alert("Fill all fields");

        const endpoint =
          currentModalType === "admin" ? "/api/admins" : "/api/clients";
        await fetch(endpoint, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ name, phone }),
        });

        closeModal();
        loadData(currentModalType + "s");
      }

      // --- WHATSAPP LOGIC ---
      socket.on("qr", (qr) => {
        const container = document.getElementById("qr-container");
        container.innerHTML = "";
        container.classList.add("bg-white");
        new QRCode(container, { text: qr, width: 180, height: 180 });
      });

      socket.on("connection_status", (data) => {
        const text = document.getElementById("conn-status-text");
        const phone = document.getElementById("conn-phone-text");
        const qr = document.getElementById("qr-container");

        if (data.status === "Connected") {
          text.innerText = "● Connected";
          text.className = "text-green-500 font-bold flex items-center gap-2";
          phone.innerText = "+" + data.phone;
          qr.classList.remove("bg-white");
          qr.innerHTML = `<div class="text-green-600 flex flex-col items-center gap-2">
                    <i class="lucide-check-circle w-12 h-12"></i>
                    <p class="font-bold">Successfully Linked</p>
                </div>`;
        } else {
          text.innerText = "● Disconnected";
          text.className = "text-red-500 font-bold flex items-center gap-2";
          phone.innerText = "None";
        }
      });

      async function logoutWA() {
        if (confirm("Disconnect device?"))
          await fetch("/api/whatsapp/logout", { method: "POST" });
      }
      async function deleteEntry(type, id) {
        if (
          !confirm(`Are you sure you want to delete this ${type.slice(0, -1)}?`)
        )
          return;

        const response = await fetch(`/api/${type}/${id}`, {
          method: "DELETE",
        });
        if (response.ok) {
          loadData(type); // This refreshes the list instantly
        } else {
          alert("Error deleting record");
        }
      }
      // Init
      showPage("dashboard");
    </script>
  </body>
</html>
